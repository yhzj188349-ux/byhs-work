<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>结算 - B站会员购</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- 统一的 Tailwind 配置 -->
  <link rel="stylesheet" href="../商城首页/css/style.css">
  <style>
    /* 修改样式部分 */
    body {
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
      padding-bottom: 120px; /* 增加底部空间，确保提交按钮不会被导航栏遮挡 */
    }
    
    .text-primary {
      color: #fb7299;
    }
    
    .bg-primary {
      background-color: #fb7299;
    }
    
    .border-primary {
      border-color: #fb7299;
    }
    
    .hover\:bg-primary:hover {
      background-color: #fb7299;
    }
    
    /* 添加动画效果 */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.3s;
    }
    .fade-enter, .fade-leave-to {
      opacity: 0;
    }
    
    /* 优化支付方式按钮样式 */
    .payment-method {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .payment-method.active {
      border-color: #fb7299;
      background-color: #fff5f7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .payment-method:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* 为提交订单按钮添加额外的底部边距 */
    .submit-button-container {
      margin-bottom: 20px;
    }
    
    /* 优化提交订单按钮样式，使其更加清晰明显 */
    .submit-order-button {
      background-color: #fb7299; /* 粉色背景 */
      color: white; /* 白色文字 */
      border: 2px solid #fb7299; /* 粉色边框 */
      font-weight: bold; /* 加粗字体 */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* 添加阴影效果 */
      transition: all 0.3s ease; /* 添加过渡效果 */
    }
    
    /* 鼠标悬停效果 */
    .submit-order-button:hover:not(:disabled) {
      background-color: #ff5a8a; /* 更深的粉色 */
      border-color: #ff5a8a;
      transform: translateY(-2px); /* 轻微上移 */
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }
    
    /* 按钮禁用状态 */
    .submit-order-button:disabled {
      background-color: #cccccc;
      border-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- 顶部导航栏 -->
  <header class="bg-pink-500 text-white sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button onclick="goBack()" class="text-white">
          <i class="fa fa-arrow-left"></i>
        </button>
        <h1 class="text-xl font-bold">结算</h1>
      </div>
      <div class="flex items-center space-x-4">
        <a href="../商城首页/index.html" class="text-white">
          <i class="fa fa-home"></i>
        </a>
      </div>
    </div>
  </header>

  <!-- 结算内容 -->
  <main class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">订单信息</h2>
      
      <div id="checkout-app">
        <!-- 收货地址 -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">收货地址</h3>
          <div id="address-display" class="border border-gray-300 rounded p-4">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium" id="address-name">张三</span>
              <span class="text-gray-600" id="address-phone">138****8888</span>
            </div>
            <p class="text-gray-600" id="address-detail">北京市朝阳区某某街道某某小区1号楼101室</p>
            <button id="edit-address-btn" class="mt-3 text-primary">
              <i class="fa fa-edit mr-1"></i>编辑地址
            </button>
          </div>
          <div id="address-form" class="border border-gray-300 rounded p-4 hidden">
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="name">收货人</label>
              <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="name" type="text" placeholder="请输入收货人姓名">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="phone">手机号码</label>
              <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="phone" type="text" placeholder="请输入手机号码">
            </div>
            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-bold mb-2" for="detail">详细地址</label>
              <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="detail" placeholder="请输入详细地址" rows="3"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
              <button id="cancel-address-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded">取消</button>
              <button id="save-address-btn" class="bg-pink-500 hover:bg-pink-600 text-white py-2 px-4 rounded">保存</button>
            </div>
          </div>
        </div>
        
        <!-- 商品列表 -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">商品列表</h3>
          <transition name="fade" mode="out-in">
            <div v-if="cart.length === 0" class="text-center py-8 text-gray-500" key="empty">
              购物车为空
            </div>
            <div v-else key="has-items">
              <div v-for="item in cart" :key="item.id" class="flex items-center border-b border-gray-200 py-4">
                <img :src="item.image" :alt="item.name" class="w-16 h-16 object-cover rounded">
                <div class="ml-4 flex-1">
                  <h4 class="font-medium text-gray-800">{{ item.name }}</h4>
                  <p class="text-gray-600">¥{{ item.price }}</p>
                  <div v-if="item.selectedAttributes && (item.selectedAttributes.style || item.selectedAttributes.size)" class="mt-1 flex flex-wrap gap-1">
                    <span v-if="item.selectedAttributes.style" class="text-xs bg-gray-100 px-2 py-0.5 rounded">{{ item.selectedAttributes.style }}</span>
                    <span v-if="item.selectedAttributes.size" class="text-xs bg-gray-100 px-2 py-0.5 rounded">{{ item.selectedAttributes.size }}</span>
                  </div>
                </div>
                <div class="flex items-center">
                  <span class="mx-2 text-gray-700">x {{ item.quantity }}</span>
                </div>
                <div class="ml-4 font-medium text-gray-800">¥{{ (item.price * item.quantity).toFixed(2) }}</div>
              </div>
            </div>
          </transition>
        </div>
        
        <!-- 订单金额 -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">订单金额</h3>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">商品总额</span>
              <span>¥{{ totalAmount.toFixed(2) }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">运费</span>
              <span class="text-green-600">免运费</span>
            </div>
            <div class="flex justify-between pt-4 border-t border-gray-300">
              <span class="font-medium">应付总额</span>
              <span class="text-xl font-bold text-primary">¥{{ totalAmount.toFixed(2) }}</span>
            </div>
          </div>
        </div>
        
        <!-- 支付方式 -->
        <div class="mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">支付方式</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="border border-primary rounded p-4 flex items-center payment-method active">
              <i class="fa-brands fa-alipay text-blue-500 text-2xl mr-2"></i>
              <span>支付宝</span>
            </div>
            <div class="border border-gray-300 rounded p-4 flex items-center payment-method">
              <i class="fa-brands fa-weixin text-green-500 text-2xl mr-2"></i>
              <span>微信支付</span>
            </div>
          </div>
        </div>
        
        <!-- 提交订单按钮 -->
        <div class="flex justify-between items-center pt-4 submit-button-container">
          <div class="text-gray-600">
            共 {{ totalItems }} 件商品
          </div>
          <button @click="submitOrder" :disabled="isProcessing" class="submit-order-button hover:bg-pink-500 text-white py-3 px-8 rounded-full font-medium transition duration-300 transform hover:scale-105">
            <span v-if="!isProcessing">提交订单 (¥{{ totalAmount.toFixed(2) }})</span>
            <span v-else>处理中...</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部导航栏 -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
    <div class="container mx-auto flex justify-around">
      <a href="../商城首页/index.html" class="flex flex-col items-center py-2 px-4 text-gray-500">
        <i class="fa fa-home text-lg"></i>
        <span class="text-xs mt-1">首页</span>
      </a>
      <a href="#" class="flex flex-col items-center py-2 px-4 text-gray-500">
        <i class="fa fa-th-large text-lg"></i>
        <span class="text-xs mt-1">分类</span>
      </a>
      <a href="../购物车/index.html" class="flex flex-col items-center py-2 px-4 text-gray-500">
        <i class="fa fa-shopping-cart text-lg"></i>
        <span class="text-xs mt-1">购物车</span>
      </a>
      <a href="#" class="flex flex-col items-center py-2 px-4 text-gray-500">
        <i class="fa fa-user text-lg"></i>
        <span class="text-xs mt-1">我的</span>
      </a>
    </div>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script>
    // 地址信息
    let addressInfo = {
      name: '张三',
      phone: '138****8888',
      detail: '北京市朝阳区某某街道某某小区1号楼101室'
    };

    // 初始化地址显示
    function initAddress() {
      loadAddress();
      renderAddress();
    }

    // 从localStorage加载地址数据
    function loadAddress() {
      try {
        const addressData = localStorage.getItem('addressInfo');
        if (addressData) {
          addressInfo = JSON.parse(addressData);
        }
      } catch (error) {
        console.error('解析地址数据失败:', error);
      }
    }

    // 保存地址数据到localStorage
    function saveAddress() {
      try {
        localStorage.setItem('addressInfo', JSON.stringify(addressInfo));
      } catch (error) {
        console.error('保存地址数据失败:', error);
      }
    }

    // 渲染地址显示
    function renderAddress() {
      document.getElementById('address-name').textContent = addressInfo.name;
      document.getElementById('address-phone').textContent = addressInfo.phone;
      document.getElementById('address-detail').textContent = addressInfo.detail;
    }

    // 显示地址编辑表单
    function showAddressForm() {
      document.getElementById('address-display').classList.add('hidden');
      document.getElementById('address-form').classList.remove('hidden');
      
      // 填充表单数据
      document.getElementById('name').value = addressInfo.name;
      document.getElementById('phone').value = addressInfo.phone;
      document.getElementById('detail').value = addressInfo.detail;
    }

    // 隐藏地址编辑表单
    function hideAddressForm() {
      document.getElementById('address-display').classList.remove('hidden');
      document.getElementById('address-form').classList.add('hidden');
    }

    // 保存地址信息
    function saveAddressInfo() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const detail = document.getElementById('detail').value.trim();
      
      if (!name || !phone || !detail) {
        alert('请填写完整的地址信息');
        return;
      }
      
      // 更新地址信息
      addressInfo.name = name;
      addressInfo.phone = phone;
      addressInfo.detail = detail;
      
      // 保存到localStorage
      saveAddress();
      
      // 更新显示
      renderAddress();
      
      // 隐藏表单
      hideAddressForm();
      
      alert('地址保存成功');
    }

    // 返回上一页
    function goBack() {
      window.history.back();
    }
    
    // Vue实例
    new Vue({
      el: '#checkout-app',
      data: {
        cart: [],
        selectedPayment: 'alipay', // 默认选择支付宝
        orderId: null,
        isProcessing: false // 支付处理状态
      },
      computed: {
        totalAmount() {
          return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        },
        totalItems() {
          return this.cart.reduce((total, item) => total + item.quantity, 0);
        }
      },
      methods: {
        loadCart() {
          // 获取购物车数据，保持与购物车页面一致的命名
          try {
            const cartData = localStorage.getItem('cartItems');
            if (cartData) {
              this.cart = JSON.parse(cartData);
              // 确保每个商品都有必要的属性
              this.cart = this.cart.map(item => ({
                id: item.id || '',
                name: item.name || '',
                price: item.price || 0,
                image: item.image || '',
                quantity: item.quantity || 1,
                selectedAttributes: item.selectedAttributes || {}
              }));
            } else {
              this.cart = [];
            }
          } catch (error) {
            console.error('解析购物车数据失败:', error);
            this.cart = [];
          }
        },
        selectPayment(method) {
          this.selectedPayment = method;
          // 更新支付方式样式
          const alipay = document.querySelector('.payment-method:nth-child(1)');
          const wechat = document.querySelector('.payment-method:nth-child(2)');
          
          if (method === 'alipay') {
            alipay.classList.add('active');
            wechat.classList.remove('active');
          } else {
            wechat.classList.add('active');
            alipay.classList.remove('active');
          }
        },
        // 生成订单ID
        generateOrderId() {
          const timestamp = new Date().getTime();
          const randomNum = Math.floor(Math.random() * 10000);
          return 'ORDER' + timestamp + randomNum;
        },
        // 模拟支付宝支付
        payWithAlipay() {
          // 生成订单ID
          this.orderId = this.generateOrderId();
          
          // 模拟支付宝支付流程
          alert('正在跳转到支付宝...');
          
          // 模拟支付处理
          setTimeout(() => {
            // 模拟支付成功
            this.handlePaymentSuccess();
          }, 2000);
        },
        // 模拟微信支付
        payWithWechat() {
          // 生成订单ID
          this.orderId = this.generateOrderId();
          
          // 模拟微信支付流程
          alert('正在跳转到微信支付...');
          
          // 模拟支付处理
          setTimeout(() => {
            // 模拟支付成功
            this.handlePaymentSuccess();
          }, 2000);
        },
        // 处理支付成功
        handlePaymentSuccess() {
          // 显示支付成功消息
          alert('支付成功！订单号：' + this.orderId);
          
          // 清空购物车
          localStorage.removeItem('cartItems');
          
          // 更新购物车数量显示
          const totalCount = 0;
          localStorage.setItem('cartCount', totalCount.toString());
          
          // 更新所有页面的购物车数量显示
          const cartCountElements = document.querySelectorAll('#cart-count, .cart-count');
          cartCountElements.forEach(element => {
            element.textContent = totalCount;
          });
          
          // 跳转到支付成功页面
          setTimeout(() => {
            window.location.href = '../支付成功页面.html?orderId=' + this.orderId + '&amount=' + this.totalAmount.toFixed(2) + '&paymentMethod=' + (this.selectedPayment === 'alipay' ? '支付宝' : '微信支付');
          }, 2000);
        },
        // 处理支付失败
        handlePaymentFailure(error) {
          alert('支付失败：' + error);
          this.isProcessing = false;
        },
        // 提交订单并支付
        submitOrder() {
          if (this.cart.length === 0) {
            alert('购物车为空，无法提交订单');
            return;
          }
          
          if (this.isProcessing) {
            return; // 防止重复提交
          }
          
          this.isProcessing = true;
          
          // 根据选择的支付方式调用对应的支付函数
          if (this.selectedPayment === 'alipay') {
            this.payWithAlipay();
          } else if (this.selectedPayment === 'wechat') {
            this.payWithWechat();
          } else {
            this.handlePaymentFailure('未知的支付方式');
          }
        }
      },
      mounted() {
        this.loadCart();
        initAddress(); // 初始化地址信息
        
        // 添加地址编辑按钮事件监听器
        document.getElementById('edit-address-btn').addEventListener('click', showAddressForm);
        
        // 添加取消按钮事件监听器
        document.getElementById('cancel-address-btn').addEventListener('click', hideAddressForm);
        
        // 添加保存按钮事件监听器
        document.getElementById('save-address-btn').addEventListener('click', saveAddressInfo);
        
        // 添加支付方式点击事件
        const alipay = document.querySelector('.payment-method:nth-child(1)');
        const wechat = document.querySelector('.payment-method:nth-child(2)');
        
        if (alipay) {
          alipay.addEventListener('click', () => {
            this.selectPayment('alipay');
          });
        }
        
        if (wechat) {
          wechat.addEventListener('click', () => {
            this.selectPayment('wechat');
          });
        }
      }
    });
  </script>
</body>
</html>